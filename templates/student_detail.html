{% extends 'layout.html' %}
{% block content %}

<div class="row">
  <div class="col-md-8">

    <h3 class="d-flex align-items-center">
      <span class="me-3">{{ student.name }}</span>
      <small class="text-muted">(Fee: {{ '%.2f'|format(student.total_fee or 0) }})</small>
    </h3>

    <div class="mb-2 text-muted">
      Joined: {{ student.created_at.strftime('%Y-%m-%d') if student.created_at else '' }}
    </div>

    <div class="mb-2">
      <strong>Points:</strong> <span id="student-points">{{ student.points or 0 }}</span>
      <button id="give-points-btn" class="btn btn-sm btn-outline-primary ms-2">Give +5</button>
    </div>

    <form id="student-form" class="mt-3">
      <div class="mb-3">
        <label class="form-label">Name</label>
        <input name="name" class="form-control" value="{{ student.name }}" />
      </div>

      <div class="mb-3">
        <label class="form-label">Email</label>
        <input name="email" class="form-control" value="{{ student.email }}" />
      </div>

      <div class="mb-3">
        <label class="form-label">Phone</label>
        <input name="phone" class="form-control" value="{{ student.phone }}" />
      </div>

      <div class="mb-3">
        <label class="form-label">Total Fee</label>
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <input name="total_fee" type="number" step="0.01" class="form-control"
                 value="{{ student.total_fee or 0 }}" />
        {% else %}
          <input name="total_fee" type="number" step="0.01" class="form-control"
                 value="{{ student.total_fee or 0 }}" readonly disabled />
        {% endif %}
      </div>

      <div class="mb-3">
        <label class="form-label">Year</label>
        <input name="year" class="form-control" value="{{ student.year }}" />
      </div>

      <hr />

      <h5>Parent / Contact</h5>

      <div class="mb-3">
        <label class="form-label">Parent Name</label>
        <input name="parent_name" class="form-control" value="{{ student.parent_name or '' }}" />
      </div>

      <div class="mb-3">
        <label class="form-label">Parent Phone</label>
        <input name="parent_phone" class="form-control" value="{{ student.parent_phone or '' }}" />
      </div>

      <div class="mb-3">
        <label class="form-label">Address</label>
        <input name="address" class="form-control" value="{{ student.address or '' }}" />
      </div>

      <button class="btn btn-success" type="submit">Save</button>
      <span id="save-status" class="ms-3"></span>
      {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <button id="delete-student-btn" type="button" class="btn btn-danger ms-2">Delete Student</button>
      {% endif %}
    </form>
  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="col-md-4">

    <h5>Fees</h5>
    <div class="mb-2">
      <div><strong>Total Fee:</strong> <span id="total-fee">{{ '%.2f'|format(student.total_fee or 0) }}</span></div>
      <div><strong>Total Paid:</strong> <span id="total-paid">{{ '%.2f'|format(student.total_paid or 0) }}</span></div>
      <div><strong>Remaining:</strong>
        <span id="remaining-fee">
          {{ '%.2f'|format((student.total_fee or 0) - (student.total_paid or 0)) }}
        </span>
      </div>
    </div>

    <hr />

    <h5>Parent & College</h5>
    <div class="mb-2">
      <div><strong>Parent:</strong> {{ student.parent_name or '' }} <small class="text-muted">{{ student.parent_phone or '' }}</small></div>
      <div><strong>Aadhar:</strong> {{ student.aadhar_number or '—' }}</div>
      <div><strong>College Admission No.:</strong> {{ student.college_admission_number or '—' }}</div>
      <div><strong>College:</strong> {{ student.college_name or '—' }}</div>
    </div>


    <h5>Installments</h5>

    <table class="table table-sm">
      <thead>
        <tr><th>#</th><th>Amount</th><th>Status</th><th></th></tr>
      </thead>
      <tbody id="installments-list"></tbody>
    </table>

    <form id="installment-form" class="mt-2">
      <div class="row g-2">
        <div class="col-6">
          <input name="amount" class="form-control" placeholder="Amount" type="number" step="0.01" />
        </div>
        <div class="col-6">
          <input name="due_date" class="form-control flatpickr-input"
                 placeholder="Due date" type="text" readonly />
        </div>
        <div class="col-12">
          <button class="btn btn-primary w-100" type="submit">Add Installment</button>
        </div>
      </div>
    </form>

  </div>
</div>

<script src="/static/js/student.js"></script>
<div id="student-data" data-sid='{{ student.id|tojson }}'></div>
<script>
  (function(){
    var el = document.getElementById('student-data');
    try {
      window.SID = el ? JSON.parse(el.getAttribute('data-sid')) : null;
    } catch (e) {
      window.SID = null;
    }
  })();
</script>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">Are you sure you want to delete this installment?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="confirm-delete-btn" type="button" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

      <!-- Delete Student Modal -->
      <div class="modal fade" id="confirmDeleteStudentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm Delete Student</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">This will permanently delete the student and all related records. Continue?</div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button id="confirm-delete-student-btn" type="button" class="btn btn-danger">Delete Student</button>
            </div>
          </div>
        </div>
      </div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

{% endblock %}

{% if current_user.is_authenticated and current_user.role == 'admin' %}
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const deleteBtn = document.getElementById('delete-student-btn');
  const confirmBtn = document.getElementById('confirm-delete-student-btn');
  if(deleteBtn && confirmBtn){
    deleteBtn.addEventListener('click', ()=>{
      const modal = new bootstrap.Modal(document.getElementById('confirmDeleteStudentModal'));
      modal.show();
    });

    confirmBtn.addEventListener('click', async ()=>{
      const sid = window.SID;
      if(!sid) return;
      try{
        const res = await fetch(`/students/${sid}/delete`, {method: 'POST', headers: {'X-Requested-With':'XMLHttpRequest'}});
        if(res.ok){
          // redirect to students list
          location.href = '/students';
        } else {
          const j = await res.json().catch(()=>({}));
          alert(j.error || 'Unable to delete student');
        }
      }catch(e){
        alert('Error deleting student');
      }
    });
  }
});
</script>
{% endif %}

