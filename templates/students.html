{% extends 'layout.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Students</h2>
  <div class="d-flex gap-2">
    <input id="student-search" class="form-control form-control-sm" placeholder="Search by name or roll" />
    <button class="btn btn-primary" id="refresh-btn">Refresh</button>
  </div>
</div>

<div class="list-group shadow-sm" id="student-list">
  {% for s in pagination.items %}
    <div class="list-group-item d-flex justify-content-between align-items-center student-row">
      <a href="/students/{{ s.id }}" class="text-decoration-none text-dark flex-grow-1">
        <div>
          <div class="fw-bold">{{ s.name }}</div>
          <div class="small text-muted">
            Fee: {{ '%.2f'|format(s.total_fee or 0) }} â€¢ {{ s.year }}
          </div>
        </div>
      </a>

      <div class="text-end ms-3">
        <div class="small">{{ s.email }}</div>
        <div class="small text-muted">{{ s.phone }}</div>

        {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <div class="mt-1">
            <button class="btn btn-sm btn-outline-danger delete-student-btn" data-id="{{ s.id }}">
              Delete
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<nav class="mt-3">
  <ul class="pagination">
    {% if pagination.has_prev %}
      <li class="page-item"><a class="page-link" href="?page={{ pagination.prev_num }}">Previous</a></li>
    {% endif %}

    <li class="page-item active"><span class="page-link">{{ pagination.page }}</span></li>

    {% if pagination.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ pagination.next_num }}">Next</a></li>
    {% endif %}
  </ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // Refresh button
  document.getElementById('refresh-btn').addEventListener('click', () => {
    location.reload();
  });

  // Search filter
  const search = document.getElementById('student-search');
  search.addEventListener('input', () => {
    const q = search.value.toLowerCase().trim();

    document.querySelectorAll('.student-row').forEach(row => {
      const txt = row.textContent.toLowerCase();
      row.style.display = txt.includes(q) ? '' : 'none';
    });
  });

});
</script>

{% if current_user.is_authenticated and current_user.role == 'admin' %}
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.delete-student-btn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const id = btn.dataset.id;
      if(!id) return;
      if(!confirm('Are you sure you want to delete this student and all related data?')) return;
      try{
        const res = await fetch(`/students/${id}/delete`, {method: 'POST', headers: {'X-Requested-With':'XMLHttpRequest'}});
        const json = await res.json().catch(()=>({}));
        if(res.ok && json.success){
          // remove element from DOM
          const row = btn.closest('.student-row');
          if(row) row.remove();
          // optional small toast
          alert('Student deleted');
        } else if(res.status === 403){
          alert('Forbidden');
        } else {
          alert(json.error || 'Unable to delete student');
        }
      }catch(err){
        alert('Error deleting student');
      }
    });
  });
});
</script>
{% endif %}

{% endblock %}
